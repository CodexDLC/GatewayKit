# Архитектура проекта

## 1. Основные принципы

Проект построен на принципах микросервисной архитектуры с асинхронным обменом сообщениями через брокер RabbitMQ.

-   **"Тонкие" приложения (`apps`) / "Толстые" библиотеки (`libs`)**: Вся основная бизнес-логика, доменные модели, инфраструктурный код и утилиты находятся в `libs`. Приложения в `apps` являются тонкими слоями, которые отвечают только за обработку входящих запросов (REST, WebSocket) и запуск фоновых обработчиков.
-   **Единый источник истины**: Конфигурации, имена очередей, доменные модели (DTO) и другие общие сущности определены в `libs` и импортируются сервисами.
-   **DI-контейнер**: Зависимости (подключения к БД, Redis, шине сообщений) управляются через простой DI-контейнер (`libs/infra/di.py`), который инициализируется при старте каждого сервиса.

## 2. Схема взаимодействия сервисов

+-----------+      +-------------------+      +------------------+
|  Клиенты  |----->|      Gateway      |----->|     RabbitMQ     |
| (WS/HTTP) |      | (REST API / WS)   |      | (Брокер сообщений) |
+-----------+      +-------------------+      +------------------+
^                     |
| (RPC-ответы)        | (RPC-запросы)
|                     v
|              +-------------+
+--------------|   Auth SVC  |
| (RPC-сервис)|
+-------------+


1.  **Gateway**: Единственная точка входа для клиентов. Отвечает за аутентификацию, валидацию, терминирование WS-сессий и преобразование HTTP/WS запросов в сообщения для внутренней шины.
2.  **RabbitMQ**: Центральный брокер сообщений. Используется для асинхронного взаимодействия между сервисами через RPC-вызовы и публикацию событий.
3.  **Auth SVC**: Сервис аутентификации. Отвечает за регистрацию, вход, валидацию и выдачу токенов. Является RPC-сервером, который слушает свою очередь в RabbitMQ.
docs/ERROR_MODEL.md
Markdown

# Модель ошибок и маппинг на HTTP

## 1. Коды ошибок

Все ошибки в системе, как внутренние, так и возвращаемые клиенту, идентифицируются уникальным строковым кодом. Эти коды определены в `libs/app/errors.py` в Enum `ErrorCode`.

Формат: `домен.описание_ошибки` (например, `auth.invalid_credentials`).

### Основные коды:

| Код | Описание |
|---|---|
| `auth.invalid_credentials` | Неверный логин или пароль. |
| `auth.token_expired` | Срок действия токена истёк. |
| `auth.invalid_token` | Токен невалиден или повреждён. |
| `auth.user_exists` | Пользователь с таким email или username уже существует. |
| `auth.forbidden` | Доступ запрещён (недостаточно прав). |
| `rpc.timeout` | Сервис-обработчик не ответил вовремя. |
| `rpc.bad_response` | Сервис-обработчик вернул некорректный или пустой ответ. |
| `validation.failed` | Ошибка валидации данных запроса. |
| `common.not_implemented` | Функционал ещё не реализован. |
| `common.internal_error` | Внутренняя ошибка сервера. |

## 2. Маппинг на HTTP-статусы

Gateway отвечает за преобразование кодов ошибок из RPC-ответов в соответствующие HTTP-статусы.

| Код ошибки (`error_code`) | HTTP-статус |
|---|---|
| `auth.invalid_credentials`| 401 Unauthorized |
| `auth.token_expired` | 401 Unauthorized |
| `auth.invalid_token` | 401 Unauthorized |
| `auth.forbidden` | 403 Forbidden |
| `auth.user_exists` | 409 Conflict |
| `validation.failed` | 400 Bad Request |
| `rpc.timeout` | 504 Gateway Timeout |
| `rpc.bad_response` | 502 Bad Gateway |
| `common.not_implemented` | 501 Not Implemented |
| `common.internal_error` | 500 Internal Server Error |
| *Любой другой* | 500 Internal Server Error |