# Работа со схемами в базе данных

## 1. Основной принцип

Каждый крупный домен или микросервис, требующий собственных таблиц в PostgreSQL, использует отдельную схему в общей базе данных `game`. Это позволяет:
- **Логически изолировать** таблицы разных доменов.
- **Избежать конфликтов имен** таблиц.
- **Гибко управлять правами доступа** на уровне схем.
- **Версионировать миграции** независимо для каждого домена.

## 2. Именование

Имя схемы должно совпадать с именем домена/сервиса. Например, для сервиса аутентификации используется схема `auth`.

## 3. Управление миграциями с Alembic

Мы используем один репозиторий Alembic в корне проекта, но с раздельным версионированием для каждой схемы.

### 3.1. Таблицы версий

Для каждой схемы создается своя таблица версий. Например:
- Схема `auth` -> таблица `alembic_version_auth`.
- Схема `inventory` -> таблица `alembic_version_inventory`.

Это настраивается в файле `migrations/env.py`.

### 3.2. Как добавить новую схему

1.  **Обновите `migrations/env.py`**: добавьте новую схему и имя ее таблицы версий в словарь `SCHEMA_VERSION_TABLES`.
    ```python
    SCHEMA_VERSION_TABLES = {
        "auth": "alembic_version_auth",
        "inventory": "alembic_version_inventory", # Новая схема
    }
    ```
2.  **Создайте начальную миграцию**: сгенерируйте "пустую" миграцию, которая создаст саму схему в БД.
    ```bash
    alembic revision --branch-label <schema_name> -m "init <schema_name> schema"
    ```
    Внутри сгенерированного файла добавьте команду:
    ```python
    def upgrade() -> None:
        op.execute("CREATE SCHEMA IF NOT EXISTS <schema_name>;")

    def downgrade() -> None:
        op.execute("DROP SCHEMA IF EXISTS <schema_name> CASCADE;")
    ```

### 3.3. Как генерировать и применять миграции

Все команды Alembic теперь требуют дополнительного аргумента `-x schema=<schema_name>`, чтобы указать, с какой схемой мы работаем.

**Создание новой миграции (автогенерация или ручная):**
```bash
# Пример для схемы 'auth'
alembic revision -x schema=auth --autogenerate -m "add users table to auth"
4. Роли и права доступа (Production)
Для обеспечения безопасности в production-среде рекомендуется использовать принцип наименьших привилегий, разделив роли в базе данных.

4.1. Описание ролей
owner: Владелец схемы (например, auth_owner). Эта роль имеет полные права на схему, включая изменение её структуры. Используется только для запуска миграций.

migrator: Роль, которой owner предоставляет права на изменение структуры таблиц (DDL: CREATE, ALTER, DROP). Учетная запись для запуска Alembic должна состоять в этой роли.

*_rw (например, auth_rw): Роль приложения. Имеет права только на операции с данными (DML: SELECT, INSERT, UPDATE, DELETE) в таблицах конкретной схемы. У сервиса не должно быть прав на изменение структуры БД.

4.2. Параметры безопасности сессии
Рекомендуется устанавливать следующие параметры для сессий, которые открывает приложение (auth_rw), чтобы предотвратить "зависшие" транзакции и долгие запросы:

statement_timeout: Ограничивает максимальное время выполнения любого запроса (например, '5s').

idle_in_transaction_session_timeout: Прерывает транзакции, которые находятся в состоянии "idle" (простаивают) дольше указанного времени (например, '10s').

Эти параметры помогают защитить базу данных от блокировок и исчерпания пула соединений.