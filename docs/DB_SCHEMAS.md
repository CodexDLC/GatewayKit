# Работа со схемами в базе данных

## 1. Основной принцип

Каждый крупный домен или микросервис, требующий собственных таблиц в PostgreSQL, использует отдельную схему в общей базе данных `game`. Это позволяет:
- **Логически изолировать** таблицы разных доменов.
- **Избежать конфликтов имен** таблиц.
- **Гибко управлять правами доступа** на уровне схем (в будущем).
- **Версионировать миграции** независимо для каждого домена.

## 2. Именование

Имя схемы должно совпадать с именем домена/сервиса. Например, для сервиса аутентификации используется схема `auth`.

## 3. Управление миграциями с Alembic

Мы используем один репозиторий Alembic в корне проекта, но с раздельным версионированием для каждой схемы.

### 3.1. Таблицы версий

Для каждой схемы создается своя таблица версий. Например:
- Схема `auth` -> таблица `alembic_version_auth`.
- Схема `inventory` -> таблица `alembic_version_inventory`.

Это настраивается в файле `migrations/env.py`.

### 3.2. Как добавить новую схему

1.  **Обновите `migrations/env.py`**: добавьте новую схему и имя ее таблицы версий в словарь `SCHEMA_VERSION_TABLES`.
    ```python
    SCHEMA_VERSION_TABLES = {
        "auth": "alembic_version_auth",
        "inventory": "alembic_version_inventory", # Новая схема
    }
    ```
2.  **Создайте начальную миграцию**: сгенерируйте "пустую" миграцию, которая создаст саму схему в БД.
    ```bash
    alembic revision --branch-label <schema_name> -m "init <schema_name> schema"
    ```
    Внутри сгенерированного файла добавьте команду:
    ```python
    def upgrade() -> None:
        op.execute("CREATE SCHEMA IF NOT EXISTS <schema_name>;")

    def downgrade() -> None:
        op.execute("DROP SCHEMA IF EXISTS <schema_name> CASCADE;")
    ```

### 3.3. Как генерировать и применять миграции

Все команды Alembic теперь требуют дополнительного аргумента `-x schema=<schema_name>`, чтобы указать, с какой схемой мы работаем.

**Создание новой миграции (автогенерация или ручная):**
```bash
# Пример для схемы 'auth'
alembic revision -x schema=auth --autogenerate -m "add users table to auth"