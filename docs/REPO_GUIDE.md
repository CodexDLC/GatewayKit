# Руководство по репозиторию

## 1. Структура

.
├── apps/                # "Тонкие" приложения (точки входа)
│   ├── auth_svc/        # Сервис аутентификации
│   └── gateway/         # API Gateway
├── docs/                # Документация
├── libs/                # "Толстые" общие библиотеки
│   ├── app/             # Код для bootstrap'а и health-чеков
│   ├── containers/      # DI-контейнеры
│   ├── domain/          # DTO, Enums, модели данных
│   ├── infra/           # Клиенты БД, Redis, и т.д.
│   ├── messaging/       # Клиент шины, имена, топология
│   └── utils/           # Утилиты (логгер, генераторы ID)
├── migrations/          # Миграции Alembic
└── docker-compose.yml   # Файл для локального запуска


## 2. Как добавить новый сервис

Предположим, нужно добавить `inventory_svc`.

1.  **Создать директорию**:
    -   Создайте `apps/inventory_svc/`.

2.  **Определить DTO**:
    -   Добавьте необходимые модели запросов и ответов в `libs/domain/dto/`.

3.  **Определить имена RMQ**:
    -   Добавьте имена RPC-очередей в `libs/messaging/rabbitmq_names.py`.
    -   `INVENTORY_GET_ITEMS_RPC = "core.inventory.rpc.get_items.v1"`

4.  **Определить топологию RMQ**:
    -   В `libs/messaging/rabbitmq_topology.py` создайте функцию `declare_inventory_topology(bus)` и добавьте в неё объявление новых очередей.

5.  **Создать обработчики (`Handlers`)**:
    -   В `apps/inventory_svc/handlers/` создайте классы, реализующие бизнес-логику (например, `get_items_handler.py`).

6.  **Создать слушатели (`Listeners`)**:
    -   В `apps/inventory_svc/listeners/` создайте классы, которые связывают очередь и обработчик.
    -   Создайте фабрики для них в `apps/inventory_svc/listeners/__init__.py`.

7.  **Создать DI-контейнер**:
    -   Если сервису нужны зависимости (например, БД), создайте `libs/containers/inventory_container.py`.

8.  **Создать точку входа**:
    -   Создайте `apps/inventory_svc/inventory_svc_main.py`, используя `create_service_app` из `libs/app/bootstrap.py`.

9.  **Добавить в `docker-compose.yml`**:
    -   Добавьте новый сервис в `docker-compose.yml` по аналогии с `auth_svc`.
    -   Создайте `apps/inventory_svc/Dockerfile`.
    -   Создайте `apps/inventory_svc/requirements.txt`.

10. **Документация**:
    -   Обновите `ARCHITECTURE.md` и другие релевантные документы.


## 3. Как запустить тесты локально

Для обеспечения стабильности кода в проекте настроен набор автоматических тестов. Любые изменения рекомендуется проверять локально перед отправкой в репозиторий.

### Требования
- Docker и Docker Compose должны быть установлены и запущены.

### Порядок запуска

Все команды выполняются из корневой директории проекта.

**1. Подготовка `.env` файла**

Если у вас нет файла `.env` в корне проекта, создайте его из шаблона:
```bash
cp .env.sample .env
Вносить изменения в этот файл для запуска тестов не требуется.

2. Запуск сервисов

Поднимите все сервисы (PostgreSQL, RabbitMQ, Redis, а также gateway и auth_svc) в фоновом режиме. Команда также пересобирает образы, если в коде были изменения.

Bash

docker compose up -d --build
3. Ожидание готовности

После запуска сервисам нужно некоторое время (обычно 15-30 секунд), чтобы полностью запуститься и установить все соединения.

4. Выполнение тестов

Запустите все тесты с помощью pytest внутри контейнера gateway:

Bash

docker compose exec gateway pytest
Вы увидите отчет о выполнении всех тестов (unit, integration, smoke, contract).

5. Остановка и очистка

После завершения тестов обязательно остановите все сервисы и удалите созданные ими ресурсы (включая тома базы данных), чтобы следующий запуск тестов происходил в чистом окружении.

Bash

docker compose down -v
