# Руководство по репозиторию

## 1. Структура

.
├── apps/                # "Тонкие" приложения (точки входа)
│   ├── auth_svc/        # Сервис аутентификации
│   └── gateway/         # API Gateway
├── docs/                # Документация
├── libs/                # "Толстые" общие библиотеки
│   ├── app/             # Код для bootstrap'а и health-чеков
│   ├── containers/      # DI-контейнеры
│   ├── domain/          # DTO, Enums, модели данных
│   ├── infra/           # Клиенты БД, Redis, и т.д.
│   ├── messaging/       # Клиент шины, имена, топология
│   └── utils/           # Утилиты (логгер, генераторы ID)
├── migrations/          # Миграции Alembic
└── docker-compose.yml   # Файл для локального запуска


## 2. Как добавить новый сервис

Предположим, нужно добавить `inventory_svc`.

1.  **Создать директорию**:
    -   Создайте `apps/inventory_svc/`.

2.  **Определить DTO**:
    -   Добавьте необходимые модели запросов и ответов в `libs/domain/dto/`.

3.  **Определить имена RMQ**:
    -   Добавьте имена RPC-очередей в `libs/messaging/rabbitmq_names.py`.
    -   `INVENTORY_GET_ITEMS_RPC = "core.inventory.rpc.get_items.v1"`

4.  **Определить топологию RMQ**:
    -   В `libs/messaging/rabbitmq_topology.py` создайте функцию `declare_inventory_topology(bus)` и добавьте в неё объявление новых очередей.

5.  **Создать обработчики (`Handlers`)**:
    -   В `apps/inventory_svc/handlers/` создайте классы, реализующие бизнес-логику (например, `get_items_handler.py`).

6.  **Создать слушатели (`Listeners`)**:
    -   В `apps/inventory_svc/listeners/` создайте классы, которые связывают очередь и обработчик.
    -   Создайте фабрики для них в `apps/inventory_svc/listeners/__init__.py`.

7.  **Создать DI-контейнер**:
    -   Если сервису нужны зависимости (например, БД), создайте `libs/containers/inventory_container.py`.

8.  **Создать точку входа**:
    -   Создайте `apps/inventory_svc/inventory_svc_main.py`, используя `create_service_app` из `libs/app/bootstrap.py`.

9.  **Добавить в `docker-compose.yml`**:
    -   Добавьте новый сервис в `docker-compose.yml` по аналогии с `auth_svc`.
    -   Создайте `apps/inventory_svc/Dockerfile`.
    -   Создайте `apps/inventory_svc/requirements.txt`.

10. **Документация**:
    -   Обновите `ARCHITECTURE.md` и другие релевантные документы.

## 3. Обновление API контрактов (JSON-схем)

Если вы вносите изменения в DTO-модели в `libs/domain/dto/` или `apps/gateway/rest/auth/dto.py`, необходимо обновить соответствующие JSON-схемы.

Для этого просто запустите скрипт:
```bash
python scripts/generate_schemas.py
После этого добавьте измененные файлы схем в ваш коммит. CI-пайплайн автоматически проверит, что схемы актуальны.

4. Как запустить тесты локально
Для обеспечения стабильности кода в проекте настроен набор автоматических тестов. Любые изменения рекомендуется проверять локально перед отправкой в репозиторий.

Требования
Docker и Docker Compose должны быть установлены и запущены.

Порядок запуска
Все команды выполняются из корневой директории проекта.

1. Подготовка .env файла

Если у вас нет файла .env в корне проекта, создайте его из шаблона:

Bash

cp .env.sample .env
Вносить изменения в этот файл для запуска тестов не требуется.

2. Запуск сервисов

Поднимите все сервисы в фоновом режиме. Команда также пересобирает образы, если в коде были изменения.

Bash

docker compose up -d --build
3. Ожидание готовности

После запуска сервисам нужно некоторое время (обычно 15-30 секунд), чтобы полностью запуститься и установить все соединения.

4. Выполнение тестов

Запустите все тесты с помощью pytest внутри контейнера gateway:

Bash

docker compose exec gateway pytest
Вы увидите отчет о выполнении всех тестов (unit, integration, smoke, contract).

5. Остановка и очистка

После завершения тестов обязательно остановите все сервисы и удалите созданные ими ресурсы (включая тома базы данных):

Bash

docker compose down -v
5. Чек-лист безопасности перед выкладкой
Этот короткий список поможет убедиться, что базовые требования безопасности выполнены перед развертыванием в production.

[ ] Секреты: Все секреты (пароли, JWT_SECRET) удалены из кода и .env файла и перенесены в защищенное хранилище (например, Vault, AWS Secrets Manager).

[ ] CORS: В конфигурации gateway список allow_origins ограничен конкретными доменами вашего фронтенда вместо ["*"].

[ ] Сложность хеширования: Переменная окружения AUTH_PASSWORD_BCRYPT_ROUNDS установлена в значение 12 или выше.

[ ] Аудит-логи: Проверено, что события регистрации, входа и выхода из системы корректно логируются с меткой audit.

[ ] Версии Docker-образов: Версии базовых образов в Dockerfile зафиксированы (запинены) до минорной версии (например, python:3.12.4-slim-bookworm).

[ ] Доступ к БД: Учетная запись, используемая приложением в production, имеет только _rw роль без прав на изменение структуры БД.