# Стандарт логирования

## 1. Формат логов

Все сервисы пишут логи в формате **NDJSON** (Newline Delimited JSON). Каждая запись лога — это одна строка, представляющая собой валидный JSON-объект. Это упрощает парсинг, фильтрацию и анализ логов в системах вроде ELK Stack или Grafana Loki.

## 2. Структура записи

Каждая запись в логе содержит стандартизированный набор полей.

| Поле       | Тип     | Описание                                       | Пример                       |
| :--------- | :------ | :--------------------------------------------- | :--------------------------- |
| `ts`       | string  | **Timestamp** в формате ISO 8601 (UTC).        | `2025-08-19T14:30:00.123Z`   |
| `level`    | string  | Уровень лога (`INFO`, `WARN`, `ERROR`).        | `INFO`                       |
| `svc`      | string  | Имя сервиса (из `CONTAINER_ID`).               | `auth_svc`                   |
| `message`  | string  | Основное сообщение лога.                       | `User authenticated successfully` |
| `req_id`   | string  | **Request ID**. Сквозной идентификатор запроса. | `req_a1b2c3d4`               |
| `user_id`  | integer | ID пользователя, если он известен.             | `1001`                       |
| `path`     | string  | HTTP-путь для REST-запросов.                   | `/auth/token`                |
| `latency_ms`| float   | Время выполнения операции в миллисекундах.     | `54.3`                       |
| `err_code` | string  | Код ошибки из `ErrorCode`, если есть.          | `auth.invalid_credentials`   |

### Пример записи лога

```json
{"ts": "2025-08-19T14:30:01.456Z", "level": "ERROR", "svc": "gateway", "message": "Failed to issue token.", "req_id": "req_a1b2c3d4", "user_id": null, "path": "/auth/token", "latency_ms": 150.7, "err_code": "rpc.timeout"}
3. Корреляция запросов (Request ID)
Gateway является точкой генерации X-Request-ID. Если клиент присылает заголовок X-Request-ID, он используется. В противном случае Gateway генерирует новый.

Этот req_id пробрасывается во все последующие RPC-вызовы в поле correlation_id.

Все сервисы, участвующие в обработке запроса, используют этот req_id в своих логах, что позволяет легко отследить всю цепочку вызовов.